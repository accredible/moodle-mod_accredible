#
# Automates release tagging and develop merge when a release PR is merged to master.
#
# Triggers:
#   1. Automatically when a PR from release/* branch is merged into master
#   2. Manually via workflow_dispatch for edge cases (hotfixes, etc.)
#
# Actions:
#   1. Extract version from version.php ($plugin->release)
#   2. Create and push annotated git tag
#   3. Merge master back into develop with --no-ff
#   4. Push develop
#   5. Trigger moodle-release.yml via workflow_call
#
name: Create Release Tag

on:
  pull_request:
    types:
      - closed
    branches:
      - master

  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to tag (e.g., release/2.4.0)'
        required: true
        type: string
      skip_develop_merge:
        description: 'Skip merging back to develop (for hotfixes)'
        required: false
        type: boolean
        default: false

jobs:
  create-release:
    # Only run if PR was merged (not just closed) and from a release branch
    # OR if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       startsWith(github.event.pull_request.head.ref, 'release/'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Determine release branch
        id: branch
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_BRANCH="${{ github.event.inputs.release_branch }}"
          else
            RELEASE_BRANCH="${{ github.event.pull_request.head.ref }}"
          fi
          echo "release_branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release branch: ${RELEASE_BRANCH}"

      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from version.php
        id: version
        run: |
          # Extract the release version from version.php
          VERSION=$(grep -oP '\$plugin->release\s*=\s*["\x27]\K[^"\x27]+' version.php)
          
          if [[ -z "${VERSION}" ]]; then
            echo "âŒ Could not extract version from version.php"
            exit 1
          fi
          
          # Ensure version starts with 'v'
          if [[ ! "${VERSION}" =~ ^v ]]; then
            VERSION="v${VERSION}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Extracted version: ${VERSION}"

      - name: Check if tag already exists
        id: check-tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "refs/tags/${VERSION}" >/dev/null 2>&1; then
            echo "âŒ Tag ${VERSION} already exists!"
            exit 1
          fi
          echo "âœ… Tag ${VERSION} does not exist, proceeding..."

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        id: create-tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_BRANCH="${{ steps.branch.outputs.release_branch }}"
          
          # Create annotated tag with release branch name as message
          git tag -a "${VERSION}" -m "Release ${VERSION} from ${RELEASE_BRANCH}"
          echo "âœ… Created tag: ${VERSION}"
          
          # Push the tag immediately
          git push origin "${VERSION}"
          echo "âœ… Pushed tag: ${VERSION}"

      - name: Merge into develop
        id: merge-develop
        if: |
          github.event_name != 'workflow_dispatch' ||
          github.event.inputs.skip_develop_merge != 'true'
        run: |
          RELEASE_BRANCH="${{ steps.branch.outputs.release_branch }}"
          
          # Fetch develop branch
          git fetch origin develop:develop
          git checkout develop
          
          # Merge master (which contains the release) into develop with --no-ff
          # This is more robust than merging the release branch which may be auto-deleted
          git merge origin/master --no-ff -m "Merge ${RELEASE_BRANCH} into develop"
          
          echo "âœ… Merged master into develop with --no-ff"

      - name: Push develop
        if: |
          github.event_name != 'workflow_dispatch' ||
          github.event.inputs.skip_develop_merge != 'true'
        run: |
          git push origin develop
          echo "âœ… Pushed develop branch"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_BRANCH="${{ steps.branch.outputs.release_branch }}"
          
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Branch** | \`${RELEASE_BRANCH}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merged to develop** | ${{ github.event.inputs.skip_develop_merge != 'true' && 'âœ… Yes' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The **Releasing in the Plugins directory** workflow will run next." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View release on Moodle.org](https://moodle.org/plugins/mod_accredible)" >> $GITHUB_STEP_SUMMARY

  # Trigger the release workflow to publish to Moodle.org
  trigger-release:
    needs: create-release
    uses: ./.github/workflows/moodle-release.yml
    with:
      tag: ${{ needs.create-release.outputs.version }}
    secrets:
      MOODLE_ORG_TOKEN: ${{ secrets.MOODLE_ORG_TOKEN }}
