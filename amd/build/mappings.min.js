define(['jquery','core/ajax','core/templates'],function($,b,c){let d={};var e={acrredibleSelect:'[id*="_accredibleattribute"]',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},f={coursefieldmapping:'coursefieldoptions',coursecustomfieldmapping:'coursecustomfieldoptions',userprofilefieldmapping:'userprofilefieldoptions'},g={init:function(a){d=a;g.setSelectValues();g.listenToAddAction();g.listenToDeleteAction();g.listenToSelectChanges()},listenToAddAction:function(){var A=$(e.addButton);A.on('click',g.addNewLine);A.each((_,B)=>g.toggleAddButton($(B).attr('data-section')))},listenToDeleteAction:function(){$(e.list).on('click','.remove-line',g.removeLine)},listenToSelectChanges:function(){$(e.list).on('change',e.acrredibleSelect,()=>g.checkForDuplicates())},getAttributeValuesCount:function(){var C=new Map();$(e.acrredibleSelect).each((_,_b)=>{var _c=$(_b).val();if(!_c)return;let D=C.get(_c)??0;D++;C.set(_c,D)});return C},checkForDuplicates:function(){var _a=g.getAttributeValuesCount();$(e.acrredibleSelect).each((_,_B)=>{var _C=$(_B).attr('id'),_d=_C.split('_accredibleattribute')[0],E=$(`#${_d}_delete_action`);$(_B).removeClass('is-invalid');E.removeClass('pb-xl-4');_a.get($(_B).val())>1&&($(_B).addClass('is-invalid'),E.addClass('pb-xl-4'))})},addNewLine:function(){var _A=$(this).attr('data-section');g.renderMappingLine({index:g.countLines(_A)+1, section:_A, accredibleoptions:d.accredibleoptions, moodleoptions:d[f[_A]]},`#${_A}_content`);setTimeout(()=>g.toggleAddButton(_A),100)},removeLine:function(){var aA=$(this).attr('data-id'),aB=$(this).attr('data-section');$(`#${aB}_mapping_line_${aA}`).remove();g.toggleAddButton(aB);g.checkForDuplicates()},countLines:function(aC){return $(`[id*="${aC}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aD)=>{var aE=$(aD);aE.val(aE.attr('data-initial-value'))})},toggleAddButton:function(aF){var aG=$(`#${aF}_add_new_line`),aH=g.countLines(aF),_D=d[f[aF]].length-1;aG.prop('disabled',aH==_D)},renderMappingLine:function(aI,aJ){c.renderForPromise('mod_accredible/mapping_line',aI).then(aK=>c.appendNodeContents(aJ,aK.html,aK.js))}};return g});
