define(['jquery','core/ajax','core/templates'],function($,b,c){var d={mappingSelects:'[id*="mapping_line"] select',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},e=['coursecustomfieldmapping','userprofilefieldmapping'],f={init:function(){f.setSelectValues();f.listenToAddAction();f.listenToDeleteAction();f.listenToSelectChanges()},listenToAddAction:function(){const a=$(d.addButton);a.on('click',f.addNewLine);a.each((_,A)=>f.toggleAddButton($(A).attr('data-section')))},listenToDeleteAction:function(){$(d.list).on('click','.remove-line',f.removeLine)},listenToSelectChanges:function(){$(d.list).on('change',d.mappingSelects,()=>f.checkForDuplicates())},getAttributeValuesCount:function(){const B=new Map();$(d.mappingSelects).each((_,C)=>{const _c=$(C).val();if(!_c)return;let D=B.get(_c)??0;D++;B.set(_c,D)});return B},checkForDuplicates:function(){const _a=f.getAttributeValuesCount();let _b=!1;$(d.mappingSelects).each((_,_B)=>{const _C=RegExp(/id_(\w+)_\d_\w+/g).exec($(_B).attr('id'))[1],_d=$(`#${_C}_delete_action`);$(_B).removeClass('is-invalid');_d.removeClass('pb-xl-4');_a.get($(_B).val())>1&&($(_B).addClass('is-invalid'),_d.addClass('pb-xl-4'),_b=!0);f.disableSubmit(_b)})},addNewLine:function(){const _A=$(this).attr('data-section'),E=f.getOptionsFromTemplate(_A);f.renderMappingLine({index:f.countLines(_A)+1, section:_A, accredibleoptions:E.accredibleoptions, moodleoptions:E.moodleoptions, hasid:e.includes(_A)},`#${_A}_content`);setTimeout(()=>f.toggleAddButton(_A),100)},removeLine:function(){const aA=$(this).attr('data-id'),aB=$(this).attr('data-section');$(`#${aB}_mapping_line_${aA}`).remove();f.toggleAddButton(aB);f.checkForDuplicates()},countLines:function(aC){return $(`[id*="${aC}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aD)=>{const aE=$(aD);aE.val(aE.attr('data-initial-value'))})},toggleAddButton:function(aF){const aG=$(`#${aF}_add_new_line`),aH=f.countLines(aF),_D=f.getMoodleOptionsCount(aF);aH==_D?aG.addClass('hidden'):aG.removeClass('hidden')},getOptionsFromTemplate:function(aI){const aJ=$(`#template_${aI}`)[0];if(!aJ)return{accredibleoptions:[],moodleoptions:[]};return{accredibleoptions:f.getOptionsFromSelect(aJ.content.querySelector('#accredibleoptions_select')),moodleoptions:f.getOptionsFromSelect(aJ.content.querySelector('#moodleoptions_select'))}},getOptionsFromSelect:function(aK){const aL=$(aK).find('option').toArray();return aL.reduce((aM,aN)=>(aM.push({name:aN.innerHTML,value:aN.value}),aM),[])},getMoodleOptionsCount:function(aO){const aP=$(`#template_${aO}`)[0];if(!aP)return 0;const aQ=aP.content.querySelector('#moodleoptions_select option');return aQ.length-1},disableSubmit:function(aR){$('input:submit[id*="id_submitbutton"]').each((_,aS)=>$(aS).attr('disabled',aR))},renderMappingLine:function(aT,aU){c.renderForPromise('mod_accredible/mapping_line',aT).then(aV=>c.appendNodeContents(aU,aV.html,aV.js))}};return f});
