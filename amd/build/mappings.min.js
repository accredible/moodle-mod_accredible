define(['jquery','core/ajax','core/templates'],function($,b,c){var d={mappingSelects:'[id*="mapping_line"] select',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},e=['coursecustomfieldmapping','userprofilefieldmapping'],f={init:function(){f.setSelectValues();f.listenToAddAction();f.listenToDeleteAction();f.listenToSelectChanges()},listenToAddAction:function(){const a=$(d.addButton);a.on('click',f.addNewLine);a.each((_,A)=>f.toggleAddButton($(A).attr('data-section')))},listenToDeleteAction:function(){$(d.list).on('click','.remove-line',f.removeLine)},listenToSelectChanges:function(){$(d.list).on('change',d.mappingSelects,()=>f.checkForDuplicates())},getAttributeValuesCount:function(){const B=new Map();$(d.mappingSelects).each((_,C)=>{const _c=$(C).val();if(!_c)return;const D=f.getOptionNameFromSelect(C);const E=`${D}_${_c}`;let F=B.get(E)??0;F++;B.set(E,F)});return B},checkForDuplicates:function(){const _a=f.getAttributeValuesCount(),_b={};let _C=!1;$(d.mappingSelects).each((_,_B)=>{const aA=RegExp(/(id_\w+_\d)_\w+/g).exec($(_B).attr('id'))[1],_d=$(`#${aA}_delete_action`),_f=f.getOptionNameFromSelect(_B);$(_B).removeClass('is-invalid');const _e=$(_B).val();_a.get(`${_f}_${_e}`)>1&&($(_B).addClass('is-invalid'),_d.addClass('pb-xl-4'),_C=!0,_b[aA]=!0);!_b[aA]&&_d.removeClass('pb-xl-4');f.disableSubmit(_C)})},addNewLine:function(){const _A=$(this).attr('data-section'),aB=f.getOptionsFromTemplate(_A);f.renderMappingLine({index:f.countLines(_A)+1, section:_A, accredibleoptions:aB.accredibleoptions, moodleoptions:aB.moodleoptions, hasid:e.includes(_A)},`#${_A}_content`);setTimeout(()=>f.toggleAddButton(_A),100)},removeLine:function(){const aC=$(this).attr('data-id'),aD=$(this).attr('data-section');$(`#${aD}_mapping_line_${aC}`).remove();f.toggleAddButton(aD);f.checkForDuplicates()},countLines:function(aE){return $(`[id*="${aE}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aF)=>{const aG=$(aF);aG.val(aG.attr('data-initial-value'))})},toggleAddButton:function(aH){const aI=$(`#${aH}_add_new_line`),aJ=f.countLines(aH),_D=f.getMoodleOptionsCount(aH);aJ==_D?aI.addClass('hidden'):aI.removeClass('hidden')},getOptionNameFromSelect(aK){const aL=$(aK).val(),aM=$(aK).find(`option[value="${aL}"]`)[0].innerHTML;return aM.replaceAll(/\W+/g,'_')},getOptionsFromTemplate:function(aN){const aO=$(`#template_${aN}`)[0];if(!aO)return{accredibleoptions:[],moodleoptions:[]};return{accredibleoptions:f.getOptionsFromSelect(aO.content.querySelector('#accredibleoptions_select')),moodleoptions:f.getOptionsFromSelect(aO.content.querySelector('#moodleoptions_select'))}},getOptionsFromSelect:function(aP){const aQ=$(aP).find('option').toArray();return aQ.reduce((aR,aS)=>(aR.push({name:aS.innerHTML,value:aS.value}),aR),[])},getMoodleOptionsCount:function(aT){const aU=$(`#template_${aT}`)[0];if(!aU)return 0;const aV=aU.content.querySelector('#moodleoptions_select option');return aV.length-1},disableSubmit:function(aW){$('input:submit[id*="id_submitbutton"]').each((_,aX)=>$(aX).attr('disabled',aW))},renderMappingLine:function(aY,aZ){c.renderForPromise('mod_accredible/mapping_line',aY).then(bA=>c.appendNodeContents(aZ,bA.html,bA.js))}};return f});
