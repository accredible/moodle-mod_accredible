define(['jquery','core/ajax','core/templates'],function($,b,c){var d={acrredibleSelect:'[id*="_accredibleattribute"]',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},e={init:function(){e.setSelectValues();e.listenToAddAction();e.listenToDeleteAction();e.listenToSelectChanges()},listenToAddAction:function(){const a=$(d.addButton);a.on('click',e.addNewLine);a.each((_,A)=>e.toggleAddButton($(A).attr('data-section')))},listenToDeleteAction:function(){$(d.list).on('click','.remove-line',e.removeLine)},listenToSelectChanges:function(){$(d.list).on('change',d.acrredibleSelect,()=>e.checkForDuplicates())},getAttributeValuesCount:function(){const B=new Map();$(d.acrredibleSelect).each((_,C)=>{const _c=$(C).val();if(!_c)return;let D=B.get(_c)??0;D++;B.set(_c,D)});return B},checkForDuplicates:function(){const _a=e.getAttributeValuesCount();$(d.acrredibleSelect).each((_,_b)=>{const _C=$(_b).attr('id'),_d=_C.split('_accredibleattribute')[0],E=$(`#${_d}_delete_action`);$(_b).removeClass('is-invalid');E.removeClass('pb-xl-4');e.disableSubmit(!1);_a.get($(_b).val())>1&&($(_b).addClass('is-invalid'),E.addClass('pb-xl-4'),e.disableSubmit(!0))})},addNewLine:function(){const _A=$(this).attr('data-section'),_B=e.getOptionsFromTemplate(_A);e.renderMappingLine({index:e.countLines(_A)+1, section:_A, accredibleoptions:_B.accredibleoptions, moodleoptions:_B.moodleoptions},`#${_A}_content`);setTimeout(()=>e.toggleAddButton(_A),100)},removeLine:function(){const aA=$(this).attr('data-id'),aB=$(this).attr('data-section');$(`#${aB}_mapping_line_${aA}`).remove();e.toggleAddButton(aB);e.checkForDuplicates()},countLines:function(aC){return $(`[id*="${aC}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aD)=>{const aE=$(aD);aE.val(aE.attr('data-initial-value'))})},toggleAddButton:function(aF){const aG=$(`#${aF}_add_new_line`),aH=e.countLines(aF),_D=e.getMoodleOptionsCount(aF);aH==_D?aG.addClass('hidden'):aG.removeClass('hidden')},getOptionsFromTemplate:function(aI){const aJ=$(`#template_${aI}`)[0];if(!aJ)return{accredibleoptions:[],moodleoptions:[]};return{accredibleoptions:e.getOptionsFromSelect(aJ.content.querySelector('#accredibleoptions_select')),moodleoptions:e.getOptionsFromSelect(aJ.content.querySelector('#moodleoptions_select'))}},getOptionsFromSelect:function(aK){const aL=$(aK).find('option').toArray();return aL.reduce((aM,aN)=>(aM.push({name:aN.innerHTML,value:aN.value}),aM),[])},getMoodleOptionsCount:function(aO){const aP=$(`#template_${aO}`)[0];if(!aP)return 0;const aQ=aP.content.querySelector('#moodleoptions_select option');return aQ.length-1},disableSubmit:function(aR){$('input:submit[id*="id_submitbutton"]').each((_,aS)=>$(aS).attr('disabled',aR))},renderMappingLine:function(aT,aU){c.renderForPromise('mod_accredible/mapping_line',aT).then(aV=>c.appendNodeContents(aU,aV.html,aV.js))}};return e});
