define(['jquery','core/ajax','core/templates'],function($,b,c){var d={mappingSelects:'[id*="mapping_line"] select',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},e=['coursecustomfieldmapping','userprofilefieldmapping'],f={init:function(){f.setSelectValues();f.listenToAddAction();f.listenToDeleteAction();f.listenToSelectChanges()},listenToAddAction:function(){const a=$(d.addButton);a.on('click',f.addNewLine);a.each((_,A)=>f.toggleAddButton($(A).attr('data-section')))},listenToDeleteAction:function(){$(d.list).on('click','.remove-line',f.removeLine)},listenToSelectChanges:function(){$(d.list).on('change',d.mappingSelects,()=>f.checkForDuplicates())},getAttributeValuesCount:function(){const B=new Map();$(d.mappingSelects).each((_,C)=>{const _c=$(C).val();if(!_c)return;let D=B.get(_c)??0;D++;B.set(_c,D)});return B},checkForDuplicates:function(){const _a=f.getAttributeValuesCount(),_b={};let _C=!1;$(d.mappingSelects).each((_,_B)=>{const E=RegExp(/(id_\w+_\d)_\w+/g).exec($(_B).attr('id'))[1],_d=$(`#${E}_delete_action`);_a.get($(_B).val())>1&&($(_B).addClass('is-invalid'),_d.addClass('pb-xl-4'),_C=!0,_b[E]=!0);!_b[E]&&($(_B).removeClass('is-invalid'),_d.removeClass('pb-xl-4'));f.disableSubmit(_C)})},addNewLine:function(){const _A=$(this).attr('data-section'),aA=f.getOptionsFromTemplate(_A);f.renderMappingLine({index:f.countLines(_A)+1, section:_A, accredibleoptions:aA.accredibleoptions, moodleoptions:aA.moodleoptions, hasid:e.includes(_A)},`#${_A}_content`);setTimeout(()=>f.toggleAddButton(_A),100)},removeLine:function(){const aB=$(this).attr('data-id'),aC=$(this).attr('data-section');$(`#${aC}_mapping_line_${aB}`).remove();f.toggleAddButton(aC);f.checkForDuplicates()},countLines:function(aD){return $(`[id*="${aD}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aE)=>{const aF=$(aE);aF.val(aF.attr('data-initial-value'))})},toggleAddButton:function(aG){const aH=$(`#${aG}_add_new_line`),aI=f.countLines(aG),_D=f.getMoodleOptionsCount(aG);aI==_D?aH.addClass('hidden'):aH.removeClass('hidden')},getOptionsFromTemplate:function(aJ){const aK=$(`#template_${aJ}`)[0];if(!aK)return{accredibleoptions:[],moodleoptions:[]};return{accredibleoptions:f.getOptionsFromSelect(aK.content.querySelector('#accredibleoptions_select')),moodleoptions:f.getOptionsFromSelect(aK.content.querySelector('#moodleoptions_select'))}},getOptionsFromSelect:function(aL){const aM=$(aL).find('option').toArray();return aM.reduce((aN,aO)=>(aN.push({name:aO.innerHTML,value:aO.value}),aN),[])},getMoodleOptionsCount:function(aP){const aQ=$(`#template_${aP}`)[0];if(!aQ)return 0;const aR=aQ.content.querySelector('#moodleoptions_select option');return aR.length-1},disableSubmit:function(aS){$('input:submit[id*="id_submitbutton"]').each((_,aT)=>$(aT).attr('disabled',aS))},renderMappingLine:function(aU,aV){c.renderForPromise('mod_accredible/mapping_line',aU).then(aW=>c.appendNodeContents(aV,aW.html,aW.js))}};return f});
