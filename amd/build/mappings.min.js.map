{"version":3,"file":"mappings.min.js","sources":["../src/mappings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * The module provides a function to refresh the user list with correct credential data.\n *\n * @module    mod_accredible\n * @package   accredible\n * @copyright Accredible <dev@accredible.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification'], function($, Ajax, Templates, Notification) {\n    const element = {\n        mappingSelects: '[id*=\"mapping_line\"] select',\n        addButton: '[id*=\"_add_new_line\"]',\n        list: '.attribute_mapping',\n    };\n    const requiresId = ['coursecustomfieldmapping', 'userprofilefieldmapping'];\n\n    const mappings = {\n        init: function() {\n            mappings.setSelectValues();\n            mappings.listenToAddAction();\n            mappings.listenToDeleteAction();\n            mappings.listenToSelectChanges();\n        },\n\n        listenToAddAction: function() {\n            const addButton = $(element.addButton);\n            addButton.on('click', mappings.addNewLine);\n            // Enable/disable add button after max attributes added\n            addButton.each((_, element) => {\n                const section = $(element).attr(\"data-section\");\n                mappings.toggleAddButton(section);\n            });\n        },\n\n        listenToDeleteAction: function() {\n            $(element.list).on('click', '.remove-line', mappings.removeLine);\n        },\n\n        listenToSelectChanges: function() {\n            $(element.list).on('change', element.mappingSelects, () => {\n                mappings.checkForDuplicates();\n            });\n        },\n\n        getAttributeValuesCount: function() {\n            const valuesCount = new Map();\n            $(element.mappingSelects).each((_, select) => {\n                const value = $(select).val();\n                if (!value) {\n                    return;\n                }\n                const name = mappings.getOptionNameFromSelect(select);\n                const key = `${name}_${value}`;\n                let occurrences = valuesCount.get(key) ?? 0;\n                occurrences++;\n                valuesCount.set(key, occurrences);\n            });\n            return valuesCount;\n        },\n\n        checkForDuplicates: function() {\n            const duplicateCount = mappings.getAttributeValuesCount();\n            const rowHasError = {};\n            let hasDuplicate = false;\n\n            $(element.mappingSelects).each((_, select) => {\n                const id = $(select).attr('id');\n                const rowId = new RegExp(/(id_\\w+_\\d)_\\w+/g).exec(id)[1]; // Get \"id_{{section}}_{{index}}\" part.\n                const deleteIconWrapper = $(`#${rowId}_delete_action`);\n\n                $(select).removeClass('is-invalid');\n\n                const value = $(select).val();\n                const name = mappings.getOptionNameFromSelect(select);\n                const key = `${name}_${value}`;\n\n                if (duplicateCount.get(key) > 1) {\n                    $(select).addClass('is-invalid');\n                    deleteIconWrapper.addClass('pb-xl-4'); // Applies padding to align delete icon.\n                    hasDuplicate = true;\n                    rowHasError[rowId] = true;\n                }\n\n                if (!rowHasError[rowId]) {\n                    deleteIconWrapper.removeClass('pb-xl-4');\n                }\n\n                mappings.disableSubmit(hasDuplicate);\n            });\n        },\n\n        addNewLine: function() {\n            const section = $(this).attr('data-section');\n            const options = mappings.getOptionsFromTemplate(section);\n            const data = {\n                index: mappings.countLines(section) + 1,\n                section: section,\n                accredibleoptions: options.accredibleoptions,\n                moodleoptions: options.moodleoptions,\n                hasid: requiresId.includes(section)\n            };\n            mappings.renderMappingLine(data, `#${section}_content`);\n            // Wait for line to be rendered then show/hide the button.\n            setTimeout(() => {\n                mappings.toggleAddButton(section);\n            }, 100);\n        },\n\n        removeLine: function() {\n            const index = $(this).attr(\"data-id\");\n            const section = $(this).attr(\"data-section\");\n            const mappingLineId = `#${section}_mapping_line_${index}`;\n            $(mappingLineId).remove();\n            mappings.toggleAddButton(section);\n            mappings.checkForDuplicates();\n        },\n\n        countLines: function(section) {\n            return $(`[id*=\"${section}_mapping_line\"]`).length;\n        },\n\n        setSelectValues: function() {\n            $('.attribute_mapping select.form-control').each((_, element) => {\n                const selectEl = $(element);\n                const value = selectEl.attr('data-initial-value');\n                selectEl.val(value);\n            });\n        },\n\n        toggleAddButton: function(section) {\n            const addBtn = $(`#${section}_add_new_line`);\n            const currentLines = mappings.countLines(section);\n            const maxLines = mappings.getMoodleOptionsCount(section);\n\n            if (currentLines == maxLines) {\n                addBtn.addClass('hidden');\n            } else {\n                addBtn.removeClass('hidden');\n            }\n        },\n\n        getOptionNameFromSelect(select) {\n            const value = $(select).val();\n            const name = $(select).find(`option[value=\"${value}\"]`)[0].innerHTML;\n\n            return name.replaceAll(/\\W+/g, '_'); // Replace all special chars to underscore.\n        },\n\n        getOptionsFromTemplate: function(section) {\n            const template = $(`#template_${section}`)[0];\n            if (!template) {\n                return {accredibleoptions: [], moodleoptions: []};\n            }\n\n            const accredibleselect = template.content.querySelector('#accredibleoptions_select');\n            const moodleselect = template.content.querySelector('#moodleoptions_select');\n\n            return {\n                accredibleoptions: mappings.getOptionsFromSelect(accredibleselect),\n                moodleoptions: mappings.getOptionsFromSelect(moodleselect)\n            };\n        },\n\n        getOptionsFromSelect: function(select) {\n            const options = $(select).find('option').toArray();\n\n            return options.reduce((options, optionElement) => {\n                options.push({\n                    name: optionElement.innerHTML,\n                    value: optionElement.value\n                });\n                return options;\n            }, []);\n        },\n\n        getMoodleOptionsCount: function(section) {\n            const template = $(`#template_${section}`)[0];\n            if (!template) {\n                return 0;\n            }\n\n            const moodleoptions = template.content.querySelector('#moodleoptions_select option');\n\n            return moodleoptions.length - 1; // Excludes blank option.\n        },\n\n        disableSubmit: function(isFormInvalid) {\n            $('input:submit[id*=\"id_submitbutton\"]').each((_, button) => {\n                $(button).attr('disabled', isFormInvalid);\n            });\n        },\n\n        /**\n         * Render a mapping line template.\n         *\n         * @param {Object} context - data for template.\n         * @param {string} containerid - id of the html element where the template will be appended.\n         * @returns {Promise} Resolves when template is rendered.\n         */\n        renderMappingLine: function(context, containerid) {\n            return Templates.renderForPromise('mod_accredible/mapping_line', context).then(function(_ref) {\n                Templates.appendNodeContents(containerid, _ref.html, _ref.js);\n                return true;\n            }).catch(Notification.exception);\n        },\n    };\n    return mappings;\n});\n"],"names":["define","$","Ajax","Templates","Notification","element","requiresId","mappings","init","setSelectValues","listenToAddAction","listenToDeleteAction","listenToSelectChanges","addButton","on","addNewLine","each","_","section","attr","toggleAddButton","removeLine","checkForDuplicates","getAttributeValuesCount","valuesCount","Map","select","value","val","key","getOptionNameFromSelect","occurrences","get","set","duplicateCount","rowHasError","hasDuplicate","id","rowId","RegExp","exec","deleteIconWrapper","removeClass","addClass","disableSubmit","this","options","getOptionsFromTemplate","data","index","countLines","accredibleoptions","moodleoptions","hasid","includes","renderMappingLine","setTimeout","remove","length","selectEl","addBtn","getMoodleOptionsCount","find","innerHTML","replaceAll","template","accredibleselect","content","querySelector","moodleselect","getOptionsFromSelect","toArray","reduce","optionElement","push","name","isFormInvalid","button","context","containerid","renderForPromise","then","_ref","appendNodeContents","html","js","catch","exception"],"mappings":"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"}