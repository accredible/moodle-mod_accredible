{"version":3,"file":"userlist_updater.min.js","sources":["../src/userlist_updater.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * The module provides a function to refresh the user list with correct credential data.\n *\n * @module    mod_accredible\n * @package   accredible\n * @copyright Accredible <dev@accredible.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification'], function($, Ajax, Templates, Notification) {\n    var t = {\n        /**\n         * Initialise the handling.\n         */\n        init: function() {\n            $('select#id_groupid').on('change', t.groupChanged);\n\n            t.lastSelectedGroup = $('select#id_groupid').val();\n            t.courseid = $('input:hidden[name=course]').val();\n            t.instanceid = $('input:hidden[name=instance-id]').val();\n            t.userwarning = $('.manual-issue-warning');\n            t.manualuserscontainer = $('#manual-issue-users-container');\n            t.unissuedusers = $('#id_chooseunissuedusers');\n            t.unissuedusersmessage = $('#fitem_id_unissueddescription');\n            t.selectallbutton = $('#fitem_id_nosubmit_checkbox_controller1, #fitem_id_nosubmit_checkbox_controller2');\n\n            if (t.lastSelectedGroup === '') {\n                t.userwarning.removeClass('hidden');\n                t.manualuserscontainer.addClass('hidden');\n            }\n            if ($('#unissued-users-container .form-group').length == 0) {\n                t.unissuedusers.hide().addClass('collapsed');\n            }\n        },\n\n        /**\n         * Manage group changes from select dropdown.\n         */\n        groupChanged: function() {\n            if ($('select#id_groupid').val() === t.lastSelectedGroup) {\n                return;\n            }\n            t.lastSelectedGroup = $('select#id_groupid').val();\n            if (t.lastSelectedGroup === '') {\n                t.displayNoUsersWarning();\n            } else {\n                Ajax.call([{\n                    methodname: 'mod_accredible_reload_users',\n                    args: {courseid: t.courseid, groupid: $('select#id_groupid').val(), instanceid: t.instanceid}\n                }])[0].done(t.updateUsers);\n\n                t.userwarning.addClass('hidden');\n                t.manualuserscontainer.removeClass('hidden');\n                t.unissuedusersmessage.removeClass('hidden');\n                t.selectallbutton.removeClass('hidden');\n            }\n        },\n\n        /**\n         * Hide users and display warning when no group is selected.\n         */\n        displayNoUsersWarning: function() {\n            var userselements = $('#manual-issue-users-container .form-group, #unissued-users-container .form-group');\n            userselements.remove();\n            t.userwarning.removeClass('hidden');\n            t.selectallbutton.addClass('hidden');\n            t.manualuserscontainer.addClass('hidden');\n            t.unissuedusersmessage.addClass('hidden');\n            t.unissuedusers.show();\n        },\n\n        /**\n         * Update the contents of the User list with the results of the AJAX call.\n         *\n         * @param {Array} response - array of users.\n         */\n        updateUsers: function(response) {\n            var context;\n            var userselements = $('#manual-issue-users-container .form-group, #unissued-users-container .form-group');\n            userselements.remove();\n\n            $(response.users).each(function(index, user) {\n                if (user.credential_url) {\n                    context = {\n                        element: {\n                            html: 'Certificate ' + user.credential_id + ' - <a href=' + user.credential_url +\n                                ' target=\"_blank\">link</a>',\n                            staticlabel: true\n                        },\n                        label: user.name + '   ' + user.email\n                    };\n                } else {\n                    context = {\n                        element: {\n                            id: 'id_users_' + user.id,\n                            name: 'users[' + user.id + ']',\n                            extraclasses: 'checkboxgroup1',\n                            selectedvalue: 1\n                        },\n                        label: user.name + '   ' + user.email\n                    };\n                }\n\n                t.renderUser(context, '#manual-issue-users-container', user.credential_url);\n            });\n\n            if (response.unissued_users.length > 0) {\n                t.unissuedusers.show();\n                $(response.unissued_users).each(function(index, user) {\n                    context = {\n                        element: {\n                            id: 'id_unissuedusers_' + user.id,\n                            name: 'unissuedusers[' + user.id + ']',\n                            extraclasses: 'checkboxgroup2',\n                            selectedvalue: 1\n                        },\n                        label: user.name + '   ' + user.email\n                    };\n\n                    t.renderUser(context, '#unissued-users-container', null);\n                });\n            } else {\n                t.unissuedusers.hide().addClass('collapsed');\n            }\n\n        },\n\n        /**\n         * Render the template with the user context.\n         *\n         * @param {Object} context - data for template.\n         * @param {string} containerid - id of the html element where the template will get append.\n         * @param {string|null} certificate - certificate url to select correct template.\n         * @returns {Promise} Resolves when template is rendered.\n         */\n        renderUser: function(context, containerid, certificate) {\n            var template = certificate ? 'core_form/element-static' : 'core_form/element-advcheckbox';\n\n            return Templates.renderForPromise(template, context).then(function(_ref) {\n                Templates.appendNodeContents(containerid, _ref.html, _ref.js);\n                return true;\n            }).catch(Notification.exception);\n        }\n    };\n    return t;\n});\n"],"names":["define","$","Ajax","Templates","Notification","t","init","on","groupChanged","lastSelectedGroup","val","courseid","instanceid","userwarning","manualuserscontainer","unissuedusers","unissuedusersmessage","selectallbutton","removeClass","addClass","length","hide","displayNoUsersWarning","call","methodname","args","groupid","done","updateUsers","remove","show","response","context","users","each","index","user","credential_url","element","html","credential_id","staticlabel","label","name","email","id","extraclasses","selectedvalue","renderUser","unissued_users","containerid","certificate","template","renderForPromise","then","_ref","appendNodeContents","js","catch","exception"],"mappings":";;;;;;;;AAwBAA,yCAAO,CAAC,SAAU,YAAa,iBAAkB,sBAAsB,SAASC,EAAGC,KAAMC,UAAWC,kBAC5FC,EAAI,CAIJC,KAAM,WACFL,EAAE,qBAAqBM,GAAG,SAAUF,EAAEG,cAEtCH,EAAEI,kBAAoBR,EAAE,qBAAqBS,MAC7CL,EAAEM,SAAWV,EAAE,6BAA6BS,MAC5CL,EAAEO,WAAaX,EAAE,kCAAkCS,MACnDL,EAAEQ,YAAcZ,EAAE,yBAClBI,EAAES,qBAAuBb,EAAE,iCAC3BI,EAAEU,cAAgBd,EAAE,2BACpBI,EAAEW,qBAAuBf,EAAE,iCAC3BI,EAAEY,gBAAkBhB,EAAE,oFAEM,KAAxBI,EAAEI,oBACFJ,EAAEQ,YAAYK,YAAY,UAC1Bb,EAAES,qBAAqBK,SAAS,WAEqB,GAArDlB,EAAE,yCAAyCmB,QAC3Cf,EAAEU,cAAcM,OAAOF,SAAS,cAOxCX,aAAc,WACNP,EAAE,qBAAqBS,QAAUL,EAAEI,oBAGvCJ,EAAEI,kBAAoBR,EAAE,qBAAqBS,MACjB,KAAxBL,EAAEI,kBACFJ,EAAEiB,yBAEFpB,KAAKqB,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CAACd,SAAUN,EAAEM,SAAUe,QAASzB,EAAE,qBAAqBS,MAAOE,WAAYP,EAAEO,eAClF,GAAGe,KAAKtB,EAAEuB,aAEdvB,EAAEQ,YAAYM,SAAS,UACvBd,EAAES,qBAAqBI,YAAY,UACnCb,EAAEW,qBAAqBE,YAAY,UACnCb,EAAEY,gBAAgBC,YAAY,aAOtCI,sBAAuB,WACCrB,EAAE,oFACR4B,SACdxB,EAAEQ,YAAYK,YAAY,UAC1Bb,EAAEY,gBAAgBE,SAAS,UAC3Bd,EAAES,qBAAqBK,SAAS,UAChCd,EAAEW,qBAAqBG,SAAS,UAChCd,EAAEU,cAAce,QAQpBF,YAAa,SAASG,cACdC,QACgB/B,EAAE,oFACR4B,SAEd5B,EAAE8B,SAASE,OAAOC,MAAK,SAASC,MAAOC,MAE/BJ,QADAI,KAAKC,eACK,CACNC,QAAS,CACLC,KAAM,eAAiBH,KAAKI,cAAgB,cAAgBJ,KAAKC,eAC7D,4BACJI,aAAa,GAEjBC,MAAON,KAAKO,KAAO,MAAQP,KAAKQ,OAG1B,CACNN,QAAS,CACLO,GAAI,YAAcT,KAAKS,GACvBF,KAAM,SAAWP,KAAKS,GAAK,IAC3BC,aAAc,iBACdC,cAAe,GAEnBL,MAAON,KAAKO,KAAO,MAAQP,KAAKQ,OAIxCvC,EAAE2C,WAAWhB,QAAS,gCAAiCI,KAAKC,mBAG5DN,SAASkB,eAAe7B,OAAS,GACjCf,EAAEU,cAAce,OAChB7B,EAAE8B,SAASkB,gBAAgBf,MAAK,SAASC,MAAOC,MAC5CJ,QAAU,CACNM,QAAS,CACLO,GAAI,oBAAsBT,KAAKS,GAC/BF,KAAM,iBAAmBP,KAAKS,GAAK,IACnCC,aAAc,iBACdC,cAAe,GAEnBL,MAAON,KAAKO,KAAO,MAAQP,KAAKQ,OAGpCvC,EAAE2C,WAAWhB,QAAS,4BAA6B,UAGvD3B,EAAEU,cAAcM,OAAOF,SAAS,cAaxC6B,WAAY,SAAShB,QAASkB,YAAaC,iBACnCC,SAAWD,YAAc,2BAA6B,uCAEnDhD,UAAUkD,iBAAiBD,SAAUpB,SAASsB,MAAK,SAASC,aAC/DpD,UAAUqD,mBAAmBN,YAAaK,KAAKhB,KAAMgB,KAAKE,KACnD,KACRC,MAAMtD,aAAauD,oBAGvBtD"}